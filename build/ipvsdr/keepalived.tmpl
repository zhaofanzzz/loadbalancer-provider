{{ $lenInst := len .instances }}

global_defs {
  vrrp_version 3
  vrrp_iptables {{ .iptablesChain }}
}

{{ if gt $lenInst 1 }}
vrrp_sync_group sync_group {
  group { {{ range $inst := .instances }}
    inst_{{ $inst.Interface}} {{ end }}
  }
}
{{ end }}

{{ range $inst := .instances }}
vrrp_instance inst_{{ $inst.Name}} {
  state {{ $inst.State }}
  interface {{ $inst.Interface }}
  virtual_router_id {{ $inst.Vrid }}
  priority {{ $inst.Priority }}
  nopreempt
  advert_int 1

  track_interface {
    {{ $inst.Interface }}
  }

  unicast_src_ip {{ $inst.MyIP }}
  unicast_peer { {{ range $inst.AllIPs }}
    {{ if ne $inst.MyIP . }} {{ . }}{{ end }} {{end }}
  }

  virtual_ipaddress {
    {{ $inst.VIP }}
  }
}
{{ end }}

# TCP
{{ range $i, $vs := .vss }}
virtual_server fwmark {{ $vs.AcceptMark }} {
  delay_loop 5
  lb_algo {{ $vs.Scheduler }}
  lb_kind DR
  persistence_timeout 360
  protocol TCP

  {{ range $j, $ip := $vs.RealServer }}
  real_server {{ $ip }} 0 {
    weight 1
    TCP_CHECK {
      connect_port 80
      connect_timeout 3
    }
  }
  {{ end }}
}
{{ end }}

# UDP
{{ range $i, $vs := .vss }}
virtual_server fwmark {{ $vs.AcceptMark }} {
  delay_loop 5
  lb_algo {{ $vs.Scheduler }}
  lb_kind DR
  persistence_timeout 360
  protocol UDP

  {{ range $j, $ip := $vs.RealServer }}
  real_server {{ $ip }} 0 {
    weight 1
    TCP_CHECK {
      connect_port 80
      connect_timeout 3
    }
  }
  {{ end }}
}
{{ end }}
